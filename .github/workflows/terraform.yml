name: Terraform CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'infra/terraform/**'

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

jobs:
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0
    
    - name: Terraform Format Check
      run: terraform fmt -check -recursive
      working-directory: infra/terraform
    
    - name: Terraform Init
      run: terraform init -backend=false
      working-directory: infra/terraform/environments/dev
    
    - name: Terraform Validate
      run: terraform validate
      working-directory: infra/terraform/environments/dev
    
    - name: Run tflint
      uses: terraform-linters/setup-tflint@v4
      with:
        tflint_version: latest
    
    - name: Init tflint
      run: tflint --init
      working-directory: infra/terraform
    
    - name: Run tflint
      run: tflint
      working-directory: infra/terraform

  plan-dev:
    name: Plan Dev Environment
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Terraform Init
      run: terraform init
      working-directory: infra/terraform/environments/dev
    
    - name: Terraform Plan
      run: terraform plan -var-file=dev.tfvars -out=tfplan
      working-directory: infra/terraform/environments/dev
    
    - name: Upload Plan
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-dev
        path: infra/terraform/environments/dev/tfplan

  deploy-dev:
    name: Deploy Dev Environment
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Terraform Init
      run: terraform init
      working-directory: infra/terraform/environments/dev
    
    - name: Terraform Apply
      run: terraform apply -var-file=dev.tfvars -auto-approve
      working-directory: infra/terraform/environments/dev
    
    - name: Output Summary
      run: |
        echo "### Terraform Apply Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Development" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ✅ Deployed" >> $GITHUB_STEP_SUMMARY

  deploy-prod:
    name: Deploy Production Environment
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Terraform Init
      run: terraform init
      working-directory: infra/terraform/environments/prod
    
    - name: Terraform Plan
      run: terraform plan -var-file=prod.tfvars -out=tfplan
      working-directory: infra/terraform/environments/prod
    
    - name: Manual Approval
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ secrets.GITHUB_TOKEN }}
        approvers: platform-team
        minimum-approvals: 2
    
    - name: Terraform Apply
      run: terraform apply tfplan
      working-directory: infra/terraform/environments/prod
    
    - name: Output Summary
      run: |
        echo "### Terraform Apply Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ✅ Deployed" >> $GITHUB_STEP_SUMMARY
